<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Brander | Production Ready</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.4s ease; }
    .config-mode { background-color: #0f172a; }
    .config-mode #main-card { background-color: #1e293b; border-color: #334155; color: white; }
    .config-mode label { color: #94a3b8; }
    .config-mode input, .config-mode textarea { background-color: #0f172a; border-color: #334155; color: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-shadow { background: #e2e8f0; border-radius: 10px; }
    /* --- FIX: make hidden truly non-interactive/non-layout --- */
.hidden { 
  display: none !important; 
}

/* Defensive: even if something toggles hidden weirdly, don't capture clicks */
#fields-editor-panel.hidden,
#modal-create-program.hidden {
  pointer-events: none !important;
}
#program-tabs { position: relative; z-index: 2; }
#btn-add-program { position: relative; z-index: 3; }

  /* --- FIX 2: guarantee "+" is clickable even if something overlays --- */
#program-tabs { position: relative; z-index: 20; }
#btn-add-program { position: relative; z-index: 30; }

   /* --- Generate button feedback (like Copy feedback) --- */
  .btn-generating {
    background-color: #2563eb !important; /* blue-600 */
    color: #ffffff !important;
    box-shadow: 0 12px 28px rgba(37, 99, 235, 0.20) !important;
  }

  .btn-generated {
    background-color: #16a34a !important; /* green-600 */
    color: #ffffff !important;
    box-shadow: 0 12px 28px rgba(22, 163, 74, 0.25) !important;
  }

  @keyframes btnPop {
    0% { transform: scale(1); }
    35% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }

  .btn-pop {
    animation: btnPop 220ms ease-out;
  } 

  /* Highlighted textarea overlay */
.hl-textarea textarea{
  background: transparent !important;
  color: transparent !important;
  caret-color: #e2e8f0; /* cursor visible en dark */
}
.hl-textarea textarea::selection{
  background: rgba(59,130,246,0.35);
}
.hl-textarea pre{
  pointer-events: none;
}
  </style>
</head>

<body class="bg-slate-50 min-h-screen pb-20">

  <div class="max-w-6xl mx-auto py-8 px-6">

    <!-- HEADER -->
    <header class="flex justify-between items-center mb-10">
      <div>
        <h1 id="title" class="text-3xl font-extrabold tracking-tight text-slate-900 transition-colors">
          Email Brander
        </h1>
        <p id="subtitle" class="text-slate-500 text-sm font-medium">
          Tellescope communications generator
        </p>
      </div>

      <div class="flex gap-2">
  <!-- NEW: Connect / Fetch Tellescope templates -->
  <button id="btn-tellescope"
    class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200 hover:shadow-md transition-all relative"
    title="Connect Tellescope">
    <span id="tellescope-dot" class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-slate-300"></span>
    <!-- icon (puedes cambiarlo) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M13.828 10.172a4 4 0 015.657 5.657l-1.414 1.414a4 4 0 01-5.657-5.657m-3.172 3.172a4 4 0 01-5.657-5.657l1.414-1.414a4 4 0 015.657 5.657" />
    </svg>
  </button>

  <!-- Existing -->
  <button id="btn-toggle-config"
    class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200 hover:shadow-md transition-all group"
    title="Edit templates">
    ...
  </button>
</div>

    </header>

    <!-- VIEW: GENERATOR (DEFAULT) -->
    <div id="view-generator" class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-500">

      <!-- Sidebar: Brand Inputs -->
      <div id="main-card"
        class="lg:col-span-5 bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 h-fit sticky top-6 transition-colors">

        <!-- Header + Program Selector -->
        <div class="mb-6 flex flex-col gap-3">
          <div class="flex items-center justify-between gap-4">
            <h2 class="text-xs font-black text-blue-600 uppercase tracking-widest flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-600 rounded-full"></span>
              Brand Settings
            </h2>

            <!-- Selector de programa -->
            <div class="flex items-center gap-2">
              <span class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Program</span>
              <select id="program_selector"
                      class="border border-slate-200 rounded-xl text-xs px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/20">
              </select>
            </div>
          </div>

          <p class="text-[11px] text-slate-400">
            Select a program to generate templates for. Templates are stored per program.
          </p>
        </div>

        <div class="space-y-5">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1 field-wrapper">
              <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Brand Name</label>
              <input type="text" id="brand_name" placeholder="Vivoro"
                class="brand-input w-full border border-slate-200 p-3.5 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all">
            </div>
            <div class="col-span-1 field-wrapper">
              <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Primary Color</label>
              <div class="flex gap-2">
                <input type="color" id="color_picker" class="h-[50px] w-14 rounded-xl border-none cursor-pointer bg-slate-100 p-1">
                <input type="text" id="brand_color" value="#F2C849"
                  class="brand-input w-full border border-slate-200 p-2 rounded-xl text-center uppercase font-mono text-sm">
              </div>
            </div>
          </div>

          <div class="field-wrapper">
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Logo URL</label>
            <input type="text" id="logo_url" placeholder="https://..."
              class="brand-input w-full border border-slate-200 p-3.5 rounded-2xl text-xs outline-none">
            <div class="mt-3 flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center overflow-hidden border border-slate-200">
                <img id="logo_preview" src="" alt="Logo preview" class="max-w-full max-h-full" style="display:none;" />
              </div>
              <span class="text-[11px] text-slate-400">Logo preview</span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1 field-wrapper">
              <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Support Email</label>
              <input type="email" id="support_email" placeholder="support@..."
                class="brand-input w-full border border-slate-200 p-3.5 rounded-2xl text-sm outline-none">
            </div>
            <div class="col-span-1 field-wrapper">
              <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Support Phone</label>
              <input type="text" id="support_phone_raw" placeholder="1445..."
                class="brand-input w-full border border-slate-200 p-3.5 rounded-2xl text-sm outline-none">
            </div>
          </div>

          <div class="pt-6 border-t border-slate-100 space-y-4">
  <!-- Dynamic fields per program (rendered from Program Fields) -->
  <div id="program-extra-fields" class="space-y-4"></div>
</div>
        </div>

        <button id="btn-generate"
          class="w-full mt-10 py-5 rounded-3xl font-bold bg-slate-200 text-slate-400 cursor-pointer uppercase text-xs tracking-[0.2em] transition-all transform active:scale-[0.98]">
          Enable / Validate
        </button>
        
        <button id="btn-push-tellescope"
  class="hidden w-full mt-3 py-5 rounded-3xl font-bold bg-slate-900 text-white cursor-pointer uppercase text-xs tracking-[0.2em] transition-all transform active:scale-[0.98]">
  Push to Tellescope
</button>

        <p class="mt-4 text-[10px] text-slate-400 leading-relaxed">
          Tip: If you still see old text after pasting updates, it's usually cached files or old localStorage values.
          Click <strong>Clear All</strong> in editor mode and hard refresh.
        </p>
      </div>

      <!-- Main Panel: Templates Buttons -->
      <div class="lg:col-span-7">
        <div id="placeholder-empty"
          class="py-32 bg-slate-100/50 rounded-[3rem] border-2 border-dashed border-slate-200 text-slate-400 text-center px-10">
          <p class="text-lg font-medium italic">
            Fill out the fields on the left <br> to process all templates.
          </p>
        </div>
        <div id="grid-results" class="hidden grid grid-cols-1 gap-4 animate-in slide-in-from-right-10 duration-700">
          <!-- Dynamic -->
        </div>
      </div>
    </div>

    <!-- VIEW: CONFIGURATION (EDITOR) -->
    <div id="view-config" class="hidden animate-in fade-in zoom-in-95 duration-300">
     <div class="mb-8 space-y-4 bg-white/90 border border-slate-200 rounded-[2rem] p-6 shadow-sm">

  <!-- TOP ROW: Title + actions -->
  <div class="flex items-center justify-between gap-4">
    <div class="space-y-1">
      <h2 class="text-3xl font-black text-slate-900 italic tracking-tight">Master Template Editor</h2>
      <p class="text-xs text-slate-600">
        Templates are stored per program. Use tabs to switch programs.
      </p>
    </div>

    <div class="flex gap-3">
      <button id="btn-edit-fields"
  class="px-5 py-3 rounded-2xl bg-white text-slate-900 font-extrabold border border-slate-300 hover:border-slate-400 hover:bg-slate-50 transition-all uppercase text-[10px] tracking-widest shadow-sm">
  Edit Program Fields
</button>


      <button id="btn-reset"
        class="px-6 py-3 rounded-2xl text-slate-400 font-bold hover:text-red-400 transition-colors uppercase text-[10px] tracking-widest">
        Clear Local Brand
      </button>

      <button id="btn-save-config"
        class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-blue-500 shadow-xl shadow-blue-900/20 transition-all uppercase text-[10px] tracking-widest">
        Save Changes
      </button>

      <button id="btn-add-template"
  class="px-5 py-3 rounded-2xl bg-white text-slate-900 font-extrabold border border-slate-300 hover:border-slate-400 hover:bg-slate-50 transition-all uppercase text-[10px] tracking-widest shadow-sm">
  + Add Template
</button>
    </div>
  </div>

  <!-- SECOND ROW: Program tabs + plus -->
  <div class="flex items-center gap-3">
    <div id="program-tabs"
      class="flex-1 flex items-center gap-2 overflow-x-auto no-scrollbar py-1">
      <!-- Tabs dinámicos -->
    </div>

    <button
  id="btn-add-program"
  onclick="window.openCreateProgramModal && window.openCreateProgramModal()"
  class="w-10 h-10 flex items-center justify-center rounded-2xl bg-slate-800/60 border border-slate-700/60 hover:border-slate-500 text-slate-200 font-black text-xl"
  type="button"
  aria-label="Add program"
>+</button>
  </div>
</div>

<!-- PANEL: Program fields editor (hidden by default) -->
<div id="fields-editor-panel" class="hidden mb-8 bg-slate-800/40 border border-slate-700/60 rounded-[2rem] p-6 space-y-4">
  <div class="flex items-center justify-between gap-4">
    <div>
      <h3 class="text-white font-extrabold text-lg">Program Fields</h3>
      <p class="text-xs text-slate-400">Core fields are locked. You can add up to 10 extra fields.</p>
    </div>
    <div class="flex gap-3">
      <button id="btn-add-field"
        class="px-5 py-2 rounded-2xl bg-slate-900/60 border border-slate-700/60 hover:border-slate-500 text-slate-200 font-bold uppercase text-[10px] tracking-widest">
        + Add Field
      </button>
      <button id="btn-save-fields"
        class="px-5 py-2 rounded-2xl bg-blue-600 hover:bg-blue-500 text-white font-bold uppercase text-[10px] tracking-widest">
        Save Fields
      </button>
      <button id="btn-close-fields"
        class="px-5 py-2 rounded-2xl bg-slate-900/60 border border-slate-700/60 hover:border-slate-500 text-slate-200 font-bold uppercase text-[10px] tracking-widest">
        Close
      </button>
    </div>
  </div>

  <div id="fields-list" class="grid grid-cols-1 gap-3">
    <!-- Dynamic fields rows -->
  </div>
</div>
<!-- MODAL: Create Program -->
<div id="modal-create-program" class="hidden fixed inset-0 z-[9999]" style="pointer-events:none;">
  <!-- backdrop -->
  <div id="modal-create-program-backdrop" class="absolute inset-0 bg-black/50"></div>

  <!-- dialog -->
  <div class="relative w-full h-full flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
      <div class="p-6 space-y-2">
        <h3 class="text-xl font-extrabold text-slate-900">Create new program</h3>
        <p class="text-sm text-slate-600">Enter a name. A slug will be generated automatically.</p>
      </div>

      <div class="px-6 pb-6">
        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1">Program name</label>
        <input id="input-new-program-name" type="text" placeholder="e.g. Care Coaching"
          class="w-full border border-slate-200 p-3.5 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all">
        <p id="modal-create-program-error" class="hidden mt-3 text-sm text-red-600 font-semibold"></p>
      </div>

      <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3">
        <button id="btn-cancel-create-program"
          class="px-5 py-3 rounded-2xl bg-white border border-slate-200 hover:border-slate-300 text-slate-700 font-bold">
          Cancel
        </button>
        <button id="btn-confirm-create-program"
          class="px-5 py-3 rounded-2xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-sm">
          Create
        </button>
      </div>
    </div>
  </div>
</div>
      <div class="grid grid-cols-1 gap-8 custom-scrollbar" id="config-editor-list">
        <!-- Dynamic -->
      </div>
    </div>

  </div>
<!-- MODAL: Connect Tellescope -->
<div id="modal-tellescope" class="hidden fixed inset-0 z-[9999]" style="pointer-events:none;">
  <div id="modal-tellescope-backdrop" class="absolute inset-0 bg-black/50"></div>

  <div class="relative w-full h-full flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
      <div class="p-6 space-y-2">
        <h3 class="text-xl font-extrabold text-slate-900">Connect Tellescope</h3>
        <p class="text-sm text-slate-600">Enter API key and Business ID to fetch templates.</p>
      </div>

      <div class="px-6 pb-6 space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1">API Key</label>
          <input id="ts_api_key" type="password" placeholder="API_KEY ..."
            class="w-full border border-slate-200 p-3.5 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all">
          <p class="mt-1 text-[10px] text-slate-400">We won’t store the API key in localStorage.</p>
        </div>

        <div>
          <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1">Business ID</label>
          <input id="ts_business_id" type="text" placeholder="e.g. 68ecf91754c0e1989763c55d"
            class="w-full border border-slate-200 p-3.5 rounded-2xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all">
        </div>

        <p id="modal-tellescope-error" class="hidden text-sm text-red-600 font-semibold"></p>
      </div>

      <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3">
        <button id="btn-cancel-tellescope"
          class="px-5 py-3 rounded-2xl bg-white border border-slate-200 hover:border-slate-300 text-slate-700 font-bold">
          Cancel
        </button>
        <button id="btn-confirm-tellescope"
          class="px-5 py-3 rounded-2xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-sm">
          Fetch templates
        </button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    // ------------- HELPERS -------------
    const $ = (id) => document.getElementById(id);
// ✅ Anclar helpers en window (evita problemas de scope / caché / module)
if (typeof window.escapeHtml !== "function") {
  window.escapeHtml = function escapeHtml(str = "") {
    return String(str || "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;",
    }[m]));
  };
}

if (typeof window.escapeAttr !== "function") {
  window.escapeAttr = function escapeAttr(str = "") {
    return window.escapeHtml(str).replace(/"/g, "&quot;");
  };
}

if (typeof window.highlightPlaceholdersToHtml !== "function") {
  window.highlightPlaceholdersToHtml = function highlightPlaceholdersToHtml(rawText = "") {
    const escaped = window.escapeHtml(rawText || "");
    return escaped.replace(/\{\{[^}]+\}\}/g, (m) => {
      return `<span class="text-red-400 font-extrabold">${m}</span>`;
    });
  };
}
    
// ---------------------------
// HTML/Placeholder helpers (GLOBAL)
// ---------------------------
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#039;"
  }[m]));
}

function escapeAttr(str) {
  return escapeHtml(str).replace(/"/g, "&quot;");
}

function highlightPlaceholdersToHtml(rawText) {
  const escaped = escapeHtml(rawText || "");
  // resalta {{...}} en rojo
  return escaped.replace(/\{\{[^}]+\}\}/g, (m) => {
    return `<span class="text-red-400 font-extrabold">${m}</span>`;
  });
}
function keyToLabel(key) {
  return String(key || "")
    .replace(/[_-]+/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

function normalizePrograms(programs) {
  return (Array.isArray(programs) ? programs : []).map((p) => {
    const prog = { ...p };

    // ✅ compatibilidad: extraFields -> fields
    if (!Array.isArray(prog.fields) && Array.isArray(prog.extraFields)) {
      prog.fields = prog.extraFields.map((key, idx) => ({
        label: keyToLabel(key),
        key,
        is_core: false,
        is_form_link: false,
        sort_order: idx + 1,
      }));
    }

    // ✅ asegurar fields siempre
    prog.fields = Array.isArray(prog.fields) ? prog.fields : [];

    // ✅ normaliza shape
    prog.fields = prog.fields
      .filter(Boolean)
      .map((f, idx) => ({
        label: f.label || keyToLabel(f.key),
        key: String(f.key || "").trim(),
        is_core: !!f.is_core,
        is_form_link: !!f.is_form_link,
        sort_order: f.sort_order ?? (idx + 1),
      }))
      .filter((f) => f.key);

    return prog;
  });
}
    const TEMPLATE_NAMES_LIST = [
      "1 Days Before - Email", "1 Hour Before - Email", "2 Days Before - Email", "5 Minutes Before - Email",
      "Appointment Confirmation - Async - Email", "Appointment Confirmation - Sync - Email", "AVS SOAP - Email",
      "Care Coaching - 1 Day Before", "Care Coaching - 1 Hour Before", "Care Coaching - 2 Days Before",
      "Care Coaching - 5 Minutes Before", "Care Coaching - Appointment Confirmation - Email",
      "Care Coaching - AVS - Email", "Care Coaching - Follow-Up - Email", "Care Coaching - Initial - Email",
      "Care Coaching - Reschedule Initial - Email", "Care Coaching - Reschedule Follow-Up - Email",
      "Refill Reminder - Email", "Sync Initial - Email", "Sync Refill - Email",
      "Order Confirmation - Email", "Tracking Info - Email", "Welcome Message - Email"
    ];

    function defaultTemplates() {
      return TEMPLATE_NAMES_LIST.map((name, i) => ({
        id: i + 1,
        name,
        html: `<!-- Paste your HTML for ${name} here -->\n<div style="color: {{brand_color}}">Welcome to {{brand_name}}</div>`
      }));
    }

    let state = {
      brand: {
        brand_name: "",
        brand_color: "#F2C849",
        logo_url: "",
        support_email: "",
        support_phone_raw: "",
        portal_url: "",
        carecoaching_initial: "",
        carecoaching_refill: ""
      },
      templates: [],
      templatesSource: "loading",
      isGenerating: false,
      invalidFields: [],
      programs: [
        { slug: "default", name: "Default Program", extraFields: ["portal_url"] },
        { slug: "care_coaching", name: "Care Coaching", extraFields: ["portal_url", "carecoaching_initial", "carecoaching_refill"] },
        { slug: "other_program", name: "Other Program", extraFields: ["portal_url"] }
      ],
      selectedProgramSlug: "default",
      selectedProgramId: null,
      tellescopeApiKey: "",                 // SOLO memoria (no localStorage)
tellescopeBusinessId: localStorage.getItem('eb_ts_business_id') || "",
tellescopeTemplates: [],              // lista traída de Tellescope
tellescopeMatches: {},                // { [localTemplateId]: tellescopeTemplateId } para programa actual
tellescopeForms: [],            // forms traídos de Tellescope
tellescopeFormMatches: {},      // { [fieldKey]: formId } por programa actual
    };

    // ------------- API HELPERS -------------

    async function apiGetTemplates(programSlug = "default") {
      const res = await fetch(`/api/templates?program_slug=${encodeURIComponent(programSlug)}`, { method: 'GET' });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || 'GET /api/templates failed');
      return Array.isArray(json.templates) ? json.templates : [];
    }

    async function apiSaveTemplates(templates, programSlug = "default") {
      const adminToken = localStorage.getItem('eb_admin_token') || "";
      const res = await fetch('/api/templates', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-admin-token': adminToken
        },
        body: JSON.stringify({ templates, program_slug: programSlug })
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || 'POST /api/templates failed');
      return true;
    }
function tsMatchesStorageKey() {
  const biz = state.tellescopeBusinessId || "no_biz";
  const prog = state.selectedProgramSlug || "default";
  return `eb_ts_matches_v1__${biz}__${prog}`;
}

function loadTsMatches() {
  try {
    const raw = localStorage.getItem(tsMatchesStorageKey());
    state.tellescopeMatches = raw ? JSON.parse(raw) : {};
  } catch {
    state.tellescopeMatches = {};
  }
}

function saveTsMatches() {
  try {
    localStorage.setItem(tsMatchesStorageKey(), JSON.stringify(state.tellescopeMatches || {}));
  } catch {}
}

function tsFormMatchesStorageKey() {
  const biz = state.tellescopeBusinessId || "no_biz";
  const prog = state.selectedProgramSlug || "default";
  return `eb_ts_form_matches_v1__${biz}__${prog}`;
}

function loadTsFormMatches() {
  try {
    const raw = localStorage.getItem(tsFormMatchesStorageKey());
    state.tellescopeFormMatches = raw ? JSON.parse(raw) : {};
  } catch {
    state.tellescopeFormMatches = {};
  }
}

function saveTsFormMatches() {
  try {
    localStorage.setItem(tsFormMatchesStorageKey(), JSON.stringify(state.tellescopeFormMatches || {}));
  } catch {}
}
    
function countTsMatches() {
  return Object.values(state.tellescopeMatches || {}).filter(Boolean).length;
}

function getTsTemplateId(tpl) {
  return tpl?.id || tpl?._id || tpl?.templateId || tpl?.originalId || "";
}

function getTsTemplateLabel(tpl) {
  return tpl?.title || tpl?.name || tpl?.subject || getTsTemplateId(tpl) || "Untitled";
}

async function tellescopeFetchTemplates(apiKey, businessId) {
  const res = await fetch("/api/tellescope/templates", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ apiKey, businessId, limit: 200, sort: "newFirst" }),
  });

  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || "Failed to fetch Tellescope templates");

  // ✅ Soporta múltiples shapes de respuesta posibles
  const templates =
    (Array.isArray(json.templates) && json.templates) ||
    (Array.isArray(json?.data?.templates) && json.data.templates) ||
    (Array.isArray(json?.result?.templates) && json.result.templates) ||
    (Array.isArray(json?.results) && json.results) ||
    (Array.isArray(json?.items) && json.items) ||
    (Array.isArray(json?.data) && json.data) ||
    (Array.isArray(json?.templates?.templates) && json.templates.templates) ||
    [];

  return templates;
}

function getTsFormId(form) {
  return form?.id || form?._id || form?.formId || "";
}

function getTsFormLabel(form) {
  return form?.title || form?.displayTitle || getTsFormId(form) || "Untitled form";
}

async function tellescopeFetchForms(apiKey, businessId) {
  const res = await fetch("/api/tellescope/forms", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ apiKey, businessId, limit: 200, sort: "newFirst" }),
  });

  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || "Failed to fetch Tellescope forms");

  return Array.isArray(json.forms) ? json.forms : (Array.isArray(json) ? json : []);
}    

function updateTellescopeDot() {
  const dot = document.getElementById('tellescope-dot');
  if (!dot) return;

  const connected = (state.tellescopeTemplates?.length || 0) > 0;
  dot.classList.remove('bg-slate-300', 'bg-emerald-500');
  dot.classList.add(connected ? 'bg-emerald-500' : 'bg-slate-300');
}

function updatePushButtonVisibility() {
  const btn = document.getElementById('btn-push-tellescope');
  if (!btn) return;

  const matches = countTsMatches();
  const shouldShow = matches > 0; // tu regla: mostrar solo si hay al menos 1 match

  btn.classList.toggle('hidden', !shouldShow);
  if (shouldShow) {
    btn.textContent = `Push to Tellescope (${matches})`;
  }
}

// Modal open/close
function openTellescopeModal() {
  const modal = document.getElementById('modal-tellescope');
  const api = document.getElementById('ts_api_key');
  const biz = document.getElementById('ts_business_id');
  const err = document.getElementById('modal-tellescope-error');
  if (!modal || !api || !biz || !err) return;

  modal.style.pointerEvents = "auto";
  modal.classList.remove('hidden');

  err.classList.add('hidden');
  err.textContent = "";

  biz.value = state.tellescopeBusinessId || "";
  api.value = ""; // siempre vacío por seguridad
  setTimeout(() => api.focus(), 50);
}

function closeTellescopeModal() {
  const modal = document.getElementById('modal-tellescope');
  if (!modal) return;
  modal.classList.add('hidden');
  modal.style.pointerEvents = "none";
}

function setTellescopeModalError(msg) {
  const err = document.getElementById('modal-tellescope-error');
  if (!err) return;
  err.textContent = msg;
  err.classList.remove('hidden');
}
// --- Wire: botón de header abre modal ---
document.getElementById('btn-tellescope')?.addEventListener('click', () => {
  openTellescopeModal();
});

// cerrar modal
document.getElementById('modal-tellescope-backdrop')?.addEventListener('click', closeTellescopeModal);
document.getElementById('btn-cancel-tellescope')?.addEventListener('click', closeTellescopeModal);

// fetch templates
document.getElementById('btn-confirm-tellescope')?.addEventListener('click', async () => {
  const apiKey = document.getElementById('ts_api_key')?.value?.trim() || "";
  const businessId = document.getElementById('ts_business_id')?.value?.trim() || "";

  if (!apiKey || !businessId) {
    setTellescopeModalError("Please enter API key and Business ID.");
    return;
  }

  // UI loading
  const btn = document.getElementById('btn-confirm-tellescope');
  const old = btn?.textContent || "Fetch templates";
  if (btn) { btn.disabled = true; btn.classList.add('opacity-70'); btn.textContent = "Fetching..."; }

  try {
    // Guarda solo businessId (OK). API key solo memoria.
    state.tellescopeApiKey = apiKey;
    state.tellescopeBusinessId = businessId;
    localStorage.setItem('eb_ts_business_id', businessId);

    const [templates, forms] = await Promise.all([
  tellescopeFetchTemplates(apiKey, businessId),
  tellescopeFetchForms(apiKey, businessId),
]);

state.tellescopeTemplates = templates;
state.tellescopeForms = (forms || []).filter(f => !f?.disabled); // opcional: filtra disabled

loadTsMatches();
loadTsFormMatches();

updateTellescopeDot();
updatePushButtonVisibility();

// IMPORTANTÍSIMO: esto re-renderiza los inputs para que aparezcan los dropdowns
updateProgramFieldsVisibility();
checkValidations();

renderResultsButtons();
closeTellescopeModal();
  } catch (e) {
    setTellescopeModalError(e?.message || String(e));
  } finally {
    if (btn) { btn.disabled = false; btn.classList.remove('opacity-70'); btn.textContent = old; }
  }
});

// Enter/Esc dentro del modal
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('modal-tellescope');
  if (!modal || modal.classList.contains('hidden')) return;

  if (e.key === 'Escape') closeTellescopeModal();
  if (e.key === 'Enter') document.getElementById('btn-confirm-tellescope')?.click();
});
    // --- PROGRAMS API ---
async function apiGetPrograms() {
  const res = await fetch('/api/programs', { method: 'GET' });
  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || 'GET /api/programs failed');
  return Array.isArray(json.programs) ? json.programs : [];
}

async function apiCreateProgram(name) {
  const adminToken = localStorage.getItem('eb_admin_token') || "";
  const res = await fetch('/api/programs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
    body: JSON.stringify({ action: "create_program", name })
  });
  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || 'create_program failed');
  return json.program;
}

async function apiUpdateProgramFields(programId, fields) {
  const adminToken = localStorage.getItem('eb_admin_token') || "";
  const res = await fetch('/api/programs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
    body: JSON.stringify({ action: "update_fields", program_id: programId, fields })
  });
  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || 'update_fields failed');
  return true;
}

    async function reloadTemplatesForCurrentProgram() {
      try {
        const templatesFromApi = await apiGetTemplates(state.selectedProgramSlug);
        if (templatesFromApi.length) {
          state.templates = templatesFromApi;
          state.templatesSource = "api";
        } else {
          state.templates = defaultTemplates();
          state.templatesSource = "defaults";
        }
      } catch (e) {
        state.templates = defaultTemplates();
        state.templatesSource = "defaults-local-fallback";
      }
    }

    // ------------- INIT -------------

    async function loadProgramsAndInitSelection() {
  // 1) intenta traer programas
  try {
  const programs = await apiGetPrograms();
  if (Array.isArray(programs) && programs.length) {
    state.programs = normalizePrograms(programs);
  } else {
    state.programs = normalizePrograms(state.programs); // fallback
  }
} catch (e) {
  state.programs = normalizePrograms(state.programs); // fallback
}

  // 2) garantiza que haya al menos 1 programa
  if (!Array.isArray(state.programs) || !state.programs.length) {
    state.programs = [{ slug: "default", name: "Default Program", fields: [] }];
  }

  // 3) selecciona programa válido
  let selected =
    state.programs.find(p => p.slug === state.selectedProgramSlug) ||
    state.programs[0];

  state.selectedProgramSlug = selected.slug || "default";
  state.selectedProgramId = selected.id ?? null;

  // 4) SIEMPRE carga templates (si falla API => defaultTemplates)
  await reloadTemplatesForCurrentProgram();
}

function renderProgramTabs() {
  const tabs = document.getElementById('program-tabs');
  if (!tabs) return;

  tabs.innerHTML = '';

  state.programs.forEach(p => {
    const btn = document.createElement('button');
    const active = p.slug === state.selectedProgramSlug;

    btn.className = [
      "px-4 py-2 rounded-2xl text-xs font-bold whitespace-nowrap border transition-all",
      active
        ? "bg-blue-600 text-white border-blue-500 shadow-md"
        : "bg-slate-900/40 text-slate-200 border-slate-700/60 hover:border-slate-500"
    ].join(' ');

    btn.textContent = p.name;

    btn.onclick = async () => {
      state.selectedProgramSlug = p.slug;
      loadTsMatches();
      loadTsFormMatches();
updatePushButtonVisibility();
      state.selectedProgramId = p.id;

      await reloadTemplatesForCurrentProgram();

      renderConfigEditor();
      renderResultsButtons();
      renderProgramTabs();

      // si panel abierto, refrescarlo
      const panel = document.getElementById('fields-editor-panel');
if (panel && !panel.classList.contains('hidden')) {
  renderFieldsEditor();
}
    };

    tabs.appendChild(btn);
  });
}

function getSelectedProgram() {
  return state.programs.find(p => p.id === state.selectedProgramId)
      || state.programs.find(p => p.slug === state.selectedProgramSlug);
}

    async function init() {

        await loadProgramsAndInitSelection();
      loadTsMatches();
      loadTsFormMatches();
updatePushButtonVisibility();
updateTellescopeDot();
  renderProgramTabs();
      // cargar program selector
      const programSelector = $('program_selector');
      programSelector.innerHTML = '';
      state.programs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.slug;
        opt.textContent = p.name;
        if (p.slug === state.selectedProgramSlug) opt.selected = true;
        programSelector.appendChild(opt);
      });
      programSelector.addEventListener('change', async (e) => {
        state.selectedProgramSlug = e.target.value;
        loadTsMatches();
        loadTsFormMatches();
updatePushButtonVisibility();
        await reloadTemplatesForCurrentProgram();
        updateProgramFieldsVisibility();
        renderConfigEditor();
        renderResultsButtons();
      });

      updateProgramFieldsVisibility();

      // Templates
      await reloadTemplatesForCurrentProgram();

      // Brand data desde localStorage
      const savedBrand = localStorage.getItem('eb_brand_db');
      if (savedBrand) {
        state.brand = JSON.parse(savedBrand);
        Object.keys(state.brand).forEach(key => {
          const el = $(key);
          if (el) el.value = state.brand[key];
        });
        if (state.brand.brand_color) {
          $('color_picker').value = state.brand.brand_color;
        }
        if (state.brand.logo_url) {
          const img = $('logo_preview');
          img.src = state.brand.logo_url;
          img.style.display = 'block';
        }
      } else {
        $('color_picker').value = state.brand.brand_color;
      }

      renderResultsButtons();
      checkValidations();
    }

    function updateProgramFieldsVisibility() {
  const program = state.programs.find(p => p.slug === state.selectedProgramSlug) || getSelectedProgram();
  const container = document.getElementById('program-extra-fields');
  if (!container) return;

  container.innerHTML = '';

  const fields = Array.isArray(program?.fields) ? program.fields : [];
  const extras = fields.filter(f => !f.is_core);

  if (!extras.length) {
    checkValidations();
    return;
  }

  const savedBrand = JSON.parse(localStorage.getItem('eb_brand_db') || "{}");

  // Forms list (si están synced)
  const forms = (state.tellescopeForms || []).slice()
    .filter(f => !f?.disabled) // opcional
    .sort((a, b) => getTsFormLabel(a).localeCompare(getTsFormLabel(b)));

  extras.forEach(f => {
    const key = String(f.key || '').trim();
    if (!key) return;

    const label = (f.label || key).trim();
    const isFormLink = !!f.is_form_link;

    const wrapper = document.createElement('div');
    wrapper.className = "field-wrapper";

    const lab = document.createElement('label');
    lab.className = "block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1";
    lab.textContent = label;
    wrapper.appendChild(lab);

    if (isFormLink) {
      const select = document.createElement('select');
      select.id = key;
      select.dataset.formLink = "1"; // para NO guardarlo como brand value
      select.className = "brand-input w-full border border-slate-200 p-3.5 rounded-2xl text-xs outline-none bg-white";

      // placeholder option
      const opt0 = document.createElement('option');
      opt0.value = "";
      opt0.textContent = forms.length ? "Select a Tellescope form…" : "Tellescope pending sync";
      select.appendChild(opt0);

      if (!forms.length) {
        select.disabled = true;
      } else {
        select.disabled = false;
        forms.forEach(form => {
          const id = getTsFormId(form);
          if (!id) return;
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = getTsFormLabel(form);
          select.appendChild(opt);
        });
      }

      // set value from localStorage mapping
      const current = (state.tellescopeFormMatches || {})[key];
      if (current) select.value = current;

      select.addEventListener('change', () => {
        const v = select.value || "";
        state.tellescopeFormMatches = state.tellescopeFormMatches || {};
        if (!v) delete state.tellescopeFormMatches[key];
        else state.tellescopeFormMatches[key] = v;

        saveTsFormMatches();
        checkValidations();
      });

      wrapper.appendChild(select);
    } else {
      const input = document.createElement('input');
      input.type = "text";
      input.id = key;
      input.placeholder = label;
      input.className = "brand-input w-full border border-slate-200 p-3.5 rounded-2xl text-xs outline-none";

      if (savedBrand[key] != null) input.value = savedBrand[key];
      input.addEventListener('input', checkValidations);

      wrapper.appendChild(input);
    }

    container.appendChild(wrapper);
  });

  checkValidations();
}

   // ------------- NAVIGATION LOGIC -------------

const btnToggleConfig = $('btn-toggle-config');

btnToggleConfig?.addEventListener('click', () => {
  const viewGen = $('view-generator');
  const viewCfg = $('view-config');

  const isEditing = document.body.classList.toggle('config-mode');

  // show/hide vistas de forma explícita (más robusto que toggle simple)
  if (isEditing) {
    viewGen?.classList.add('hidden');
    viewCfg?.classList.remove('hidden');

    renderProgramTabs();
    renderConfigEditor();
  } else {
    viewCfg?.classList.add('hidden');
    viewGen?.classList.remove('hidden');

    updateProgramFieldsVisibility();
    checkValidations();
    renderResultsButtons();
  }
});

    document.getElementById("btn-push-tellescope")?.addEventListener("click", async () => {
  const btn = document.getElementById("btn-push-tellescope");
  if (!btn) return;

  // Si no hay API key (porque refrescaste página), pide reconectar
  if (!state.tellescopeApiKey) {
    alert("You need to reconnect Tellescope (API key) before pushing.");
    openTellescopeModal();
    return;
  }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "Pushing...";

  // Opcional: estilo “loading”
  btn.classList.remove("bg-red-600", "bg-emerald-600");
  btn.classList.add("opacity-80");

  try {
    const result = await tellescopePushMatchedTemplates();

    const ok = result.updatedCount || 0;
    const total = result.total || 0;

    // ✅ status final
    btn.classList.remove("opacity-80");
    btn.classList.add("bg-emerald-600");
    btn.textContent = `Success: ${ok} templates updated`;

    // si quieres ver cuáles fallaron:
    const failed = (result.results || []).filter(r => !r.ok);
    if (failed.length) {
      console.warn("Some templates failed to update:", failed);
      // puedes mostrar un alert si quieres
      alert(`Updated ${ok}/${total}. ${failed.length} failed. Check console.`);
    }
  } catch (e) {
    console.error(e);
    btn.classList.remove("opacity-80");
    btn.classList.add("bg-red-600");
    btn.textContent = `Error: ${e?.message || String(e)}`;
  } finally {
    btn.disabled = false;

    // Si prefieres que vuelva a “Push to Tellescope (N)” luego de 2s:
    setTimeout(() => {
      btn.classList.remove("bg-red-600", "bg-emerald-600");
      btn.textContent = oldText;
      updatePushButtonVisibility(); // si ya tienes esta función
    }, 2500);
  }
});

    // ---------- FIELDS EDITOR UI ----------
document.getElementById('btn-edit-fields')?.addEventListener('click', () => {
  const panel = document.getElementById('fields-editor-panel');
  if (!panel) return;
  panel.classList.toggle('hidden');
  renderFieldsEditor();
});

document.getElementById('btn-close-fields')?.addEventListener('click', () => {
  document.getElementById('fields-editor-panel')?.classList.add('hidden');
});

document.getElementById('btn-add-field')?.addEventListener('click', () => {
  addExtraField();
  renderFieldsEditor();
});

document.getElementById('btn-save-fields')?.addEventListener('click', async () => {
  try {
    const program = getSelectedProgram();
    if (!program) throw new Error("Program not found");

    program.fields = Array.isArray(program.fields) ? program.fields : [];
    program.fields.forEach((f, i) => {
      if (f.sort_order == null) f.sort_order = i + 1;
      if (f.is_core) f.is_form_link = false; // core nunca
    });

    await apiUpdateProgramFields(program.id, program.fields);
    alert("Fields saved!");
  } catch (e) {
    alert("Error saving fields: " + (e?.message || String(e)));
  }
});

function renderFieldsEditor() {
  const program = getSelectedProgram();
  const list = document.getElementById('fields-list');
  if (!program || !list) return;

  program.fields = Array.isArray(program.fields) ? program.fields : [];
  program.fields.sort((a,b) => (a.sort_order ?? 0) - (b.sort_order ?? 0));

  const core = program.fields.filter(f => f.is_core);
  const extras = program.fields.filter(f => !f.is_core);

  list.innerHTML = '';

  // CORE (locked, sin toggle)
  core.forEach((f) => {
    f.is_form_link = false;

    const row = document.createElement('div');
    row.className =
      "grid grid-cols-1 md:grid-cols-[1.2fr_1fr_auto] gap-3 items-center " +
      "bg-slate-900/30 border border-slate-700/60 rounded-2xl p-4";

    row.innerHTML = `
      <div class="text-slate-200 font-bold">${window.escapeHtml(f.label || '')}</div>
      <input disabled value="${window.escapeAttr(f.key || '')}"
        class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-400 font-mono" />
      <div class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest justify-self-end">
        Core field
      </div>
    `;
    list.appendChild(row);
  });

  // EXTRAS (editable + toggle form link)
  extras.forEach((f) => {
    const row = document.createElement('div');
    row.className =
      "grid grid-cols-1 md:grid-cols-[1.2fr_1fr_0.9fr_auto] gap-3 items-center " +
      "bg-slate-900/30 border border-slate-700/60 rounded-2xl p-4";

    row.innerHTML = `
      <input class="pf-label bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100"
        value="${escapeAttr(f.label || '')}" placeholder="Label (e.g. Portal URL)" />

      <input class="pf-key bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100 font-mono"
        value="${escapeAttr(f.key || '')}" placeholder="placeholder key (e.g. portal_url)" />

      <label class="inline-flex items-center gap-2 text-xs text-slate-200/80 font-bold select-none">
        <input type="checkbox" class="pf-toggle accent-blue-500" ${f.is_form_link ? "checked" : ""} />
        <span>Form link</span>
      </label>

      <button type="button" class="pf-del px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-200 text-xs font-bold">
        Delete
      </button>
    `;

    const labelInput = row.querySelector('.pf-label');
    const keyInput   = row.querySelector('.pf-key');
    const toggle      = row.querySelector('.pf-toggle');
    const delBtn      = row.querySelector('.pf-del');

    labelInput.addEventListener('input', (e) => { f.label = e.target.value; });

    keyInput.addEventListener('input', (e) => {
      const oldKey = String(f.key || '').trim();
      const newKey = e.target.value.replace(/\s+/g,'_');
      f.key = newKey;

      // migra form match si existía
      if (oldKey && newKey && oldKey !== newKey) {
        const cur = state.tellescopeFormMatches?.[oldKey];
        if (cur) {
          state.tellescopeFormMatches[newKey] = cur;
          delete state.tellescopeFormMatches[oldKey];
          saveTsFormMatches();
        }
      }
    });

    toggle.addEventListener('change', (e) => {
      f.is_form_link = !!e.target.checked;

      // si lo apaga, borra match
      const key = String(f.key || '').trim();
      if (!f.is_form_link && key && state.tellescopeFormMatches?.[key]) {
        delete state.tellescopeFormMatches[key];
        saveTsFormMatches();
      }
    });

    delBtn.addEventListener('click', () => {
      const key = String(f.key || '').trim();
      program.fields = program.fields.filter(x => x !== f);

      if (key && state.tellescopeFormMatches?.[key]) {
        delete state.tellescopeFormMatches[key];
        saveTsFormMatches();
      }

      renderFieldsEditor();
    });

    list.appendChild(row);
  });

  // + Add Field disabled si >= 10 extras
  const addBtn = document.getElementById('btn-add-field');
  if (addBtn) {
    addBtn.disabled = extras.length >= 10;
    addBtn.classList.toggle('opacity-50', extras.length >= 10);
  }
}

function addExtraField() {
  const program = getSelectedProgram();
  if (!program) return;

  program.fields = Array.isArray(program.fields) ? program.fields : [];
  const extras = program.fields.filter(f => !f.is_core);
  if (extras.length >= 10) return;

  program.fields.push({
    label: "",
    key: "",
    is_core: false,
    is_form_link: false,
    sort_order: program.fields.length + 1
  });
}

    // ------------- CONFIG EDITOR -------------
let templatesSortable = null;

function nextTemplateId() {
  const nums = (state.templates || [])
    .map(t => Number(t.id))
    .filter(n => Number.isFinite(n));
  const max = nums.length ? Math.max(...nums) : 0;
  return max + 1;
}

function deleteTemplateById(id) {
  if (!confirm("Delete this template?")) return;

  state.templates = (state.templates || []).filter(t => String(t.id) !== String(id));

  // Si ese template estaba matcheado a Tellescope, borra el match
  if (state.tellescopeMatches && state.tellescopeMatches[id]) {
    delete state.tellescopeMatches[id];
    saveTsMatches();
    updatePushButtonVisibility();
  }

  renderConfigEditor();
  renderResultsButtons(); // para que el generator se mantenga consistente
}

function initTemplatesSortable() {
  const list = document.getElementById('config-editor-list');
  if (!list || typeof Sortable === 'undefined') return;

  // Si ya existe, destrúyelo (renderConfigEditor se llama varias veces)
  if (templatesSortable) {
    templatesSortable.destroy();
    templatesSortable = null;
  }

  templatesSortable = new Sortable(list, {
    animation: 150,
    handle: '.drag-handle',
    onEnd: () => {
      const idsInDomOrder = Array.from(list.children)
        .map(el => el.dataset.templateId)
        .filter(Boolean);

      const byId = new Map((state.templates || []).map(t => [String(t.id), t]));
      state.templates = idsInDomOrder.map(id => byId.get(String(id))).filter(Boolean);

      // Re-render para que el #1 #2 #3 refleje el nuevo orden visual
      renderConfigEditor();
    }
  });
}
    function renderConfigEditor() {
  const list = document.getElementById('config-editor-list');
  if (!list) return;

  list.innerHTML = '';

  (state.templates || []).forEach((t, idx) => {
    const card = document.createElement('div');
    card.className = "bg-slate-800/50 p-6 rounded-[2rem] border border-slate-700/50 space-y-4";
    card.dataset.templateId = String(t.id);

    // Header row: drag + number + name + delete
    const header = document.createElement('div');
    header.className = "flex flex-col md:flex-row gap-4 items-center";

    const left = document.createElement('div');
    left.className = "flex items-center gap-3 w-full";

    // drag handle
    const drag = document.createElement('button');
    drag.type = "button";
    drag.className = "drag-handle cursor-grab active:cursor-grabbing text-slate-300 px-2 py-2 rounded-xl bg-slate-900/60 border border-slate-700/60";
    drag.title = "Drag to reorder";
    drag.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M7 4h2v2H7V4zm4 0h2v2h-2V4zM7 9h2v2H7V9zm4 0h2v2h-2V9zM7 14h2v2H7v-2zm4 0h2v2h-2v-2z"/>
      </svg>
    `;

    // number (visual order)
    const num = document.createElement('span');
    num.className = "text-slate-600 font-black text-xl italic w-10";
    num.textContent = `#${idx + 1}`;

    // name input
    const nameInput = document.createElement('input');
    nameInput.type = "text";
    nameInput.value = t.name || "";
    nameInput.className = "flex-1 bg-slate-900 border border-slate-700 p-4 rounded-2xl text-blue-400 font-bold outline-none focus:border-blue-500 w-full";
    nameInput.addEventListener('input', () => {
      const tpl = (state.templates || []).find(x => String(x.id) === String(t.id));
      if (tpl) tpl.name = nameInput.value;
    });

    left.appendChild(drag);
    left.appendChild(num);
    left.appendChild(nameInput);

    // delete
    const del = document.createElement('button');
    del.type = "button";
    del.className = "px-4 py-3 rounded-2xl bg-red-500/10 border border-red-500/30 text-red-200 font-extrabold uppercase text-[10px] tracking-widest";
    del.textContent = "Delete";
    del.addEventListener('click', () => deleteTemplateById(t.id));

    header.appendChild(left);
    header.appendChild(del);

    // Highlighted editor (pre + textarea overlay)
    const editorWrap = document.createElement('div');
    editorWrap.className = "hl-textarea relative w-full h-64 rounded-3xl bg-slate-950 border border-slate-800 overflow-hidden";

    const pre = document.createElement('pre');
    pre.className = "absolute inset-0 m-0 p-6 overflow-auto text-xs font-mono text-slate-500 whitespace-pre-wrap break-words leading-6";
    pre.innerHTML = window.highlightPlaceholdersToHtml(t.html || "");

    const ta = document.createElement('textarea');
    ta.className = "absolute inset-0 m-0 p-6 overflow-auto resize-none text-xs font-mono leading-6 outline-none";
    ta.spellcheck = false;
    ta.value = t.html || "";

    // input: actualiza state + highlight
    ta.addEventListener('input', () => {
      const tpl = (state.templates || []).find(x => String(x.id) === String(t.id));
      if (tpl) tpl.html = ta.value;
      pre.innerHTML = window.highlightPlaceholdersToHtml(ta.value);
    });

    // scroll sync
    ta.addEventListener('scroll', () => {
      pre.scrollTop = ta.scrollTop;
      pre.scrollLeft = ta.scrollLeft;
    });

    editorWrap.appendChild(pre);
    editorWrap.appendChild(ta);

    card.appendChild(header);
    card.appendChild(editorWrap);

    list.appendChild(card);
  });

  initTemplatesSortable();
}

    window.updateTempName = (i, val) => { state.templates[i].name = val; };
    window.updateTempHtml = (i, val) => { state.templates[i].html = val; };

    $('btn-save-config').addEventListener('click', async () => {
      try {
        await apiSaveTemplates(state.templates, state.selectedProgramSlug);
        alert("Templates saved to Supabase!");
      } catch (err) {
        alert("Error saving templates: " + (err?.message || String(err)));
      }
    });

    $('btn-reset').addEventListener('click', () => {
      if (confirm("Are you sure? This will clear localStorage data (brand state) for this browser.")) {
        localStorage.removeItem('eb_brand_db');
        location.reload();
      }
    });

    // ------------- GENERATOR LOGIC -------------

    function checkValidations() {
      const inputs = Array.from(document.querySelectorAll('.brand-input'));
      const btn = $('btn-generate');
      // Si estamos mostrando feedback (generating/success), no tocar el botón
if (btn?.dataset?.feedback) return;

      const visibleInputs = inputs.filter(input => input.offsetParent !== null);
      const allFilled = visibleInputs.every(input => input.value.trim() !== "");

      if (allFilled) {
        btn.disabled = false;
        btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
        btn.classList.add('bg-blue-600', 'text-white', 'shadow-xl', 'shadow-blue-200', 'cursor-pointer');
        btn.innerText = state.isGenerating ? "Generating…" : "Generate Templates";
      } else {
        btn.disabled = false; // se valida en el click
        btn.classList.remove('bg-blue-600', 'text-white', 'shadow-xl', 'shadow-blue-200', 'cursor-pointer');
        btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-pointer');
        btn.innerText = "Enable / Validate";
      }
    }

    document.querySelectorAll('.brand-input').forEach(i =>
      i.addEventListener('input', checkValidations)
    );
function setGenerateButtonMode(mode) {
  const btn = $('btn-generate');
  if (!btn) return;

  // Limpia estado anterior
  btn.classList.remove('btn-generating', 'btn-generated', 'btn-pop');

  if (mode === 'idle') {
    delete btn.dataset.feedback;
    btn.disabled = false;
    checkValidations(); // vuelve al estado normal (Enable/Generate)
    return;
  }

  // Bloquea para que checkValidations no lo pise
  btn.dataset.feedback = mode;
  btn.classList.add('btn-pop');

  if (mode === 'generating') {
    btn.disabled = true;
    btn.classList.add('btn-generating');
    btn.innerHTML = `
      <span class="inline-flex items-center justify-center gap-2">
        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"></path>
        </svg>
        Generating…
      </span>
    `;
    return;
  }

  if (mode === 'success') {
    btn.disabled = true;
    btn.classList.add('btn-generated');
    btn.innerHTML = `
      <span class="inline-flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span class="animate-pulse">Templates generated</span>
      </span>
    `;

    // Después de 1.2s vuelve al estado normal
    window.setTimeout(() => {
      btn.classList.remove('btn-generated', 'btn-pop');
      delete btn.dataset.feedback;
      btn.disabled = false;
      checkValidations();
    }, 1200);

    return;
  }
}
    $('btn-generate').addEventListener('click', async () => {
  // limpiar errores previos
  state.invalidFields = [];
  document.querySelectorAll('.brand-input').forEach(input => {
    input.classList.remove('border-red-300', 'bg-red-50');
  });

  const inputs = Array.from(document.querySelectorAll('.brand-input'));
  const visibleInputs = inputs.filter(input => input.offsetParent !== null);
  const invalid = visibleInputs.filter(input => input.value.trim() === "");

  if (invalid.length > 0) {
    state.invalidFields = invalid.map(i => i.id);
    invalid.forEach(input => {
      input.classList.add('border-red-300', 'bg-red-50');
    });
    alert("Please fill all visible fields before generating.");
    return;
  }

  saveBrandState();
  state.isGenerating = true;

  // ✅ feedback generating
  setGenerateButtonMode('generating');

  try {
    renderResultsButtons();

    // ✅ feedback success (similar a copy)
    setGenerateButtonMode('success');
  } catch (e) {
    console.error(e);
    setGenerateButtonMode('idle');
    alert("Error generating templates: " + (e?.message || String(e)));
  } finally {
    state.isGenerating = false;
  }
});

    function saveBrandState() {
  const brandVisible = {};
  const allInputs = Array.from(document.querySelectorAll('.brand-input'));

  allInputs
    .filter(input => input.id && input.offsetParent !== null && !input.dataset.formLink)
    .forEach(input => {
      brandVisible[input.id] = input.value;
    });

  if (brandVisible.brand_color) {
    brandVisible.brand_color = normalizeHexColor(brandVisible.brand_color);
  }

  const prev = JSON.parse(localStorage.getItem('eb_brand_db') || "{}");
  const merged = { ...prev, ...brandVisible };
  localStorage.setItem('eb_brand_db', JSON.stringify(merged));
  state.brand = merged;
}

   function escapeRegex(str) {
  return String(str || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function buildFinalHtmlForTemplate(t) {
  const program = getSelectedProgram();
  const fields = Array.isArray(program?.fields) ? program.fields : [];

  const replacements = {
    ...state.brand,
    support_phone_formatted: formatPhoneNumber(state.brand.support_phone_raw)
  };

  // ✅ para fields con form link: usamos el match formId y generamos sintaxis Tellescope
  fields
    .filter(f => !f.is_core && f.is_form_link)
    .forEach(f => {
      const key = String(f.key || '').trim();
      if (!key) return;

      const formId = (state.tellescopeFormMatches || {})[key];
      if (!formId) return;

      replacements[key] = `{{forms.${formId}.link:$LINK_ONLY}}`;
    });

  let finalHtml = t.html;

  Object.keys(replacements).forEach(key => {
    const regex = new RegExp(`{{${escapeRegex(key)}}}`, 'g');
    finalHtml = finalHtml.replace(regex, () => String(replacements[key] ?? ""));
  });

  return finalHtml;
}
function renderResultsButtons() {
  const grid = $('grid-results');
  const placeholder = $('placeholder-empty');

  // Mantén tu lógica actual: si no hay brand_name, no mostramos cards
  if (!state.brand.brand_name) return;

  grid.innerHTML = '';
  placeholder.classList.add('hidden');
  grid.classList.remove('hidden');

  const tsEnabled = Array.isArray(state.tellescopeTemplates) && state.tellescopeTemplates.length > 0;

  // Ordena templates de Tellescope por label (opcional)
  const tsSorted = (state.tellescopeTemplates || []).slice().sort((a,b) => {
    return getTsTemplateLabel(a).localeCompare(getTsTemplateLabel(b));
  });

  state.templates.forEach(t => {
    const finalHtml = buildFinalHtmlForTemplate(t);

    const card = document.createElement('div');
    card.className =
      "relative flex items-center justify-between p-6 bg-white border border-slate-200 rounded-3xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left group shadow-sm";
    
    // copy toast
    const toast = document.createElement('div');
    toast.className = "copy-toast hidden absolute right-4 top-4 px-3 py-2 rounded-xl bg-emerald-50 border border-emerald-500 text-emerald-700 text-xs font-bold";
    toast.textContent = "HTML copied!";
    card.appendChild(toast);

    // left
    const left = document.createElement('div');
    left.className = "flex flex-col gap-1 min-w-0";
    left.innerHTML = `
      <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest leading-none">Template #${t.id}</span>
      <span class="font-bold text-slate-700 leading-tight group-hover:text-blue-600 truncate">${t.name}</span>
    `;
    card.appendChild(left);

    // right
    const right = document.createElement('div');
    right.className = "flex items-center gap-3 flex-shrink-0";
    card.appendChild(right);

    // Match select (solo si ya hiciste fetch)
    if (tsEnabled) {
      const select = document.createElement('select');
      select.className = "ts-match-select border border-slate-200 rounded-2xl text-[10px] px-3 py-2 bg-white font-bold max-w-[240px]";
      
      const opt0 = document.createElement('option');
      opt0.value = "";
      opt0.textContent = "Match Tellescope…";
      select.appendChild(opt0);

      tsSorted.forEach(ts => {
        const id = getTsTemplateId(ts);
        if (!id) return;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = getTsTemplateLabel(ts);
        select.appendChild(opt);
      });

      // set selected match (si existe)
      const current = (state.tellescopeMatches || {})[t.id];
      if (current) select.value = current;

      select.addEventListener('click', (e) => e.stopPropagation());
      select.addEventListener('change', () => {
        const value = select.value || "";
        state.tellescopeMatches = state.tellescopeMatches || {};

        if (!value) delete state.tellescopeMatches[t.id];
        else state.tellescopeMatches[t.id] = value;

        saveTsMatches();
        updatePushButtonVisibility();
      });

      right.appendChild(select);
    }

    // Copy button
    const copyBtn = document.createElement('button');
    copyBtn.type = "button";
    copyBtn.className = "copy-btn p-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50";
    copyBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
      </svg>
    `;
    copyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      copyToClipboard(finalHtml, card);
    });
    right.appendChild(copyBtn);

    // Opcional: click en toda la card también copia (excepto select/copybtn)
    card.addEventListener('click', (e) => {
      if (e.target.closest('.ts-match-select')) return;
      if (e.target.closest('.copy-btn')) return;
      copyToClipboard(finalHtml, card);
    });

    grid.appendChild(card);
  });

  updateTellescopeDot();
  updatePushButtonVisibility();
}


    // ------------- HELPERS -------------

    function formatPhoneNumber(raw) {
      const cleaned = ('' + raw).replace(/\D/g, '');
      const match = cleaned.match(/^(1|)?(\d{3})(\d{3})(\d{4})$/);
      return match ? `(${match[2]}) ${match[3]}-${match[4]}` : raw;
    }

    async function copyToClipboard(text, cardEl) {
  // intenta Clipboard API
  try {
    await navigator.clipboard.writeText(text);
  } catch {
    // fallback
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  }

  // feedback (toast dentro de la card)
  const toast = cardEl?.querySelector?.('.copy-toast');
  if (toast) {
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 1200);
  }
}


    function normalizeHexColor(v) {
      let value = String(v || "").trim();
      if (!value) return "";
      if (!value.startsWith('#')) value = '#' + value;
      value = value.toUpperCase();
      return value;
    }

    $('color_picker').addEventListener('input', (e) => {
      const normalized = normalizeHexColor(e.target.value);
      $('brand_color').value = normalized;
      checkValidations();
    });

    $('brand_color').addEventListener('input', (e) => {
      const normalized = normalizeHexColor(e.target.value);
      e.target.value = normalized;
      $('color_picker').value = normalized || '#000000';
      checkValidations();
    });

    $('logo_url').addEventListener('input', (e) => {
      const url = (e.target.value || '').trim();
      const img = $('logo_preview');
      if (!url) {
        img.style.display = 'none';
        img.src = '';
        return;
      }
      img.style.display = 'block';
      img.src = url;
    });

    async function tellescopePushMatchedTemplates() {
  if (!state.tellescopeApiKey) {
    throw new Error("Missing API key. Reconnect Tellescope.");
  }

  const matches = state.tellescopeMatches || {};
  const updates = [];

  for (const t of state.templates) {
    const tsTemplateId = matches[t.id];
    if (!tsTemplateId) continue;

    updates.push({
      templateId: tsTemplateId,
      html: buildFinalHtmlForTemplate(t),
    });
  }

  if (!updates.length) {
    throw new Error("No matched templates to push.");
  }

  const res = await fetch("/api/tellescope/push", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      apiKey: state.tellescopeApiKey,
      businessId: state.tellescopeBusinessId,
      updates,
    }),
  });

  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(json.error || "Push failed");

  return json; // { updatedCount, total, results }
}
// ---------- CREATE PROGRAM MODAL ----------
function openCreateProgramModal() {
  const modal = document.getElementById('modal-create-program');
  const input = document.getElementById('input-new-program-name');
  const err = document.getElementById('modal-create-program-error');

  if (!modal || !input || !err) return;

  // enable interactions
  modal.style.pointerEvents = "auto";

  err.classList.add('hidden');
  err.textContent = '';
  input.value = '';

  modal.classList.remove('hidden');

  setTimeout(() => input.focus(), 50);
}

function closeCreateProgramModal() {
  const modal = document.getElementById('modal-create-program');
  if (modal) {
    modal.classList.add('hidden');
    // disable interactions when hidden
    modal.style.pointerEvents = "none";
  }
}

function setCreateProgramError(msg) {
  const err = document.getElementById('modal-create-program-error');
  if (!err) return;
  err.textContent = msg;
  err.classList.remove('hidden');
}

// close on backdrop click
document.getElementById('modal-create-program-backdrop')?.addEventListener('click', () => {
  closeCreateProgramModal();
});

document.getElementById('btn-cancel-create-program')?.addEventListener('click', () => {
  closeCreateProgramModal();
});

document.getElementById('btn-confirm-create-program')?.addEventListener('click', async () => {
  const input = document.getElementById('input-new-program-name');
  if (!input) return;

  const name = input.value.trim();
  if (!name) {
    setCreateProgramError("Please enter a program name.");
    return;
  }

  // UI: disable button while saving
  const btn = document.getElementById('btn-confirm-create-program');
  if (btn) {
    btn.disabled = true;
    btn.classList.add('opacity-60');
    btn.textContent = "Creating...";
  }

  try {
    await apiCreateProgram(name);
    await loadProgramsAndInitSelection();
    renderProgramTabs();
    renderConfigEditor();

    closeCreateProgramModal();
  } catch (e) {
    setCreateProgramError(e?.message || String(e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.classList.remove('opacity-60');
      btn.textContent = "Create";
    }
  }
});

// submit with Enter
document.getElementById('input-new-program-name')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('btn-confirm-create-program')?.click();
  }
  if (e.key === 'Escape') {
    closeCreateProgramModal();
  }
});

// also allow Esc to close when modal open
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('modal-create-program');
  if (!modal || modal.classList.contains('hidden')) return;
  if (e.key === 'Escape') closeCreateProgramModal();
});
document.getElementById('btn-add-template')?.addEventListener('click', () => {
  const newId = nextTemplateId();
  state.templates = state.templates || [];
  state.templates.push({
    id: newId,
    name: `New Template ${newId}`,
    html: `<!-- Paste your HTML here -->\n<div>Hello {{brand_name}}</div>`
  });
  renderConfigEditor();
});
    // ------------- START -------------

    init().catch((e) => {
  console.error("INIT FAILED:", e);
  // fallback mínimo: no te deja UI en blanco si init revienta
  state.templates = (state.templates && state.templates.length) ? state.templates : defaultTemplates();
  try { renderProgramTabs(); } catch {}
  try { updateProgramFieldsVisibility(); } catch {}
  try { checkValidations(); } catch {}
});
  </script>
</body>
</html>
